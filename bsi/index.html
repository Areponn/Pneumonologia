<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kalkulator BSI – Bronchiectasis Severity Index</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --surface2: #1c2330;
    --border: #30363d;
    --accent: #58a6ff;
    --text: #e6edf3;
    --text-muted: #8b949e;
    --low: #3fb950;
    --mid: #d29922;
    --high: #f85149;
    --btn-bg: #21262d;
    --btn-hover: #2d333b;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'IBM Plex Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 2rem 1rem 3rem;
  }

  .container { max-width: 860px; margin: 0 auto; }

  /* HEADER */
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    color: var(--text-muted);
    text-decoration: none;
    font-size: 0.78rem;
    margin-bottom: 1.25rem;
    padding: 0.3rem 0.6rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    transition: color 0.15s, border-color 0.15s, background 0.15s;
  }
  .back-link:hover {
    color: var(--accent);
    border-color: var(--accent);
    background: #1a2a3d;
  }

  header {
    border-left: 3px solid var(--accent);
    padding-left: 1.25rem;
    margin-bottom: 2.5rem;
  }
  header .tag {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--accent);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }
  header h1 {
    font-size: 1.75rem;
    font-weight: 300;
    margin-top: 0.25rem;
    line-height: 1.3;
  }
  header p {
    font-size: 0.82rem;
    color: var(--text-muted);
    margin-top: 0.4rem;
  }

  /* PARAM BLOCKS */
  .param-block {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.2rem 1.5rem;
    margin-bottom: 0.8rem;
    transition: border-color 0.2s;
  }
  .param-block:hover { border-color: #444c56; }

  .param-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.85rem;
    gap: 1rem;
  }

  .param-name-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
  }

  .param-name {
    font-size: 0.95rem;
    font-weight: 500;
    color: var(--text);
  }

  /* ICON BUTTONS */
  .icon-btn {
    background: none;
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 0.8rem;
    padding: 0.2rem 0.45rem;
    transition: background 0.15s, color 0.15s, border-color 0.15s;
    line-height: 1;
    flex-shrink: 0;
  }
  .icon-btn:hover {
    background: var(--btn-hover);
    color: var(--accent);
    border-color: var(--accent);
  }

  .param-score {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.8rem;
    color: var(--text-muted);
    white-space: nowrap;
    flex-shrink: 0;
    transition: color 0.2s;
  }
  .param-score.scored { color: var(--accent); font-weight: 600; }

  /* OPTION BUTTONS */
  .btn-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  .opt-btn {
    background: var(--btn-bg);
    border: 1px solid var(--border);
    border-radius: 5px;
    color: var(--text-muted);
    cursor: pointer;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 0.85rem;
    padding: 0.45rem 0.9rem;
    transition: background 0.15s, border-color 0.15s, color 0.15s;
    user-select: none;
    line-height: 1.4;
  }
  .opt-btn:hover {
    background: var(--btn-hover);
    border-color: #58a6ff88;
    color: var(--text);
  }
  .opt-btn.selected {
    background: #1a2a3d;
    border-color: var(--accent);
    color: var(--text);
    font-weight: 600;
  }
  .opt-btn .pts {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.72rem;
    margin-left: 0.35rem;
    opacity: 0.55;
  }
  .opt-btn.selected .pts { opacity: 1; color: var(--accent); }

  /* RESET BUTTON */
  .reset-btn {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    background: none;
    border: 1px solid var(--border);
    border-radius: 5px;
    color: var(--text-muted);
    cursor: pointer;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 0.82rem;
    padding: 0.4rem 0.85rem;
    margin-bottom: 1.2rem;
    transition: background 0.15s, color 0.15s, border-color 0.15s;
  }
  .reset-btn:hover {
    background: var(--btn-hover);
    color: var(--high);
    border-color: var(--high);
  }

  /* RESULT */
  .result-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 1.75rem;
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
    align-items: flex-start;
  }
  .score-circle {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 100px;
  }
  .score-number {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 4rem;
    font-weight: 600;
    line-height: 1;
    transition: color 0.35s;
  }
  .score-max {
    font-size: 0.68rem;
    color: var(--text-muted);
    margin-top: 0.2rem;
    font-family: 'IBM Plex Mono', monospace;
  }
  .result-right { flex: 1; min-width: 200px; }
  .severity-label {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.2rem;
    transition: color 0.35s;
  }
  .severity-range {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.72rem;
    color: var(--text-muted);
    margin-bottom: 0.6rem;
  }
  .result-desc {
    font-size: 0.87rem;
    color: var(--text-muted);
    line-height: 1.6;
  }
  .outcomes-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.6rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border);
    width: 100%;
  }
  .outcome-box {
    background: var(--surface2);
    border-radius: 5px;
    padding: 0.6rem 0.75rem;
    text-align: center;
  }
  .outcome-val {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 1.05rem;
    font-weight: 600;
    transition: color 0.35s;
  }
  .outcome-lbl {
    font-size: 0.67rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: 0.2rem;
  }

  /* BREAKDOWN */
  .breakdown {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border);
    width: 100%;
  }
  .breakdown-title {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
  }
  .breakdown-bar-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.3rem;
  }
  .blabel {
    width: 190px;
    flex-shrink: 0;
    color: var(--text-muted);
    font-size: 0.77rem;
  }
  .blabel.has { color: var(--text); }
  .bar-track {
    flex: 1;
    height: 5px;
    background: var(--surface2);
    border-radius: 3px;
    overflow: hidden;
  }
  .bar-fill {
    height: 100%;
    border-radius: 3px;
    background: var(--accent);
    transition: width 0.3s ease;
  }
  .bscore {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.75rem;
    width: 28px;
    text-align: right;
    color: var(--text-muted);
  }
  .bscore.has { color: var(--accent); font-weight: 600; }

  /* SOURCE */
  .source {
    margin-top: 1.25rem;
    font-size: 0.73rem;
    color: var(--text-muted);
    line-height: 1.6;
    padding: 0.75rem 1rem;
    border-left: 2px solid var(--border);
  }
  .source em { font-style: italic; }

  /* COLOR CLASSES */
  .c-low  { color: var(--low); }
  .c-mid  { color: var(--mid); }
  .c-high { color: var(--high); }

  /* ========================
     MODAL OVERLAY
  ======================== */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.65);
    backdrop-filter: blur(3px);
    z-index: 100;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1.75rem;
    max-width: 480px;
    width: 100%;
    position: relative;
    animation: modalIn 0.18s ease;
  }

  @keyframes modalIn {
    from { opacity: 0; transform: scale(0.96) translateY(8px); }
    to   { opacity: 1; transform: scale(1) translateY(0); }
  }

  .modal-close {
    position: absolute;
    top: 0.9rem;
    right: 1rem;
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 1.1rem;
    cursor: pointer;
    line-height: 1;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    transition: color 0.15s, background 0.15s;
  }
  .modal-close:hover { color: var(--text); background: var(--btn-hover); }

  .modal h2 {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 1.25rem;
    color: var(--text);
    padding-right: 2rem;
  }

  /* BMI CALCULATOR */
  .bmi-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }
  .bmi-field label {
    display: block;
    font-size: 0.73rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-muted);
    margin-bottom: 0.35rem;
  }
  .bmi-field input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 5px;
    color: var(--text);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 1rem;
    padding: 0.5rem 0.75rem;
    outline: none;
    transition: border-color 0.2s;
  }
  .bmi-field input:focus { border-color: var(--accent); }

  .bmi-result {
    background: var(--surface2);
    border-radius: 6px;
    padding: 1rem;
    text-align: center;
    margin-top: 0.5rem;
  }
  .bmi-result .bmi-val {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 2.2rem;
    font-weight: 600;
    color: var(--accent);
  }
  .bmi-result .bmi-cat {
    font-size: 0.82rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
  }
  .bmi-apply-btn {
    width: 100%;
    margin-top: 0.85rem;
    background: var(--accent);
    border: none;
    border-radius: 5px;
    color: #0d1117;
    cursor: pointer;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 0.88rem;
    font-weight: 600;
    padding: 0.6rem;
    transition: opacity 0.15s;
  }
  .bmi-apply-btn:hover { opacity: 0.85; }
  .bmi-apply-btn:disabled { opacity: 0.35; cursor: default; }

  /* MRC TABLE */
  .mrc-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }
  .mrc-table th {
    text-align: left;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-muted);
    padding: 0.4rem 0.6rem;
    border-bottom: 1px solid var(--border);
  }
  .mrc-table td {
    padding: 0.6rem 0.6rem;
    border-bottom: 1px solid #21262d;
    vertical-align: top;
    line-height: 1.5;
    color: var(--text-muted);
  }
  .mrc-table tr:last-child td { border-bottom: none; }
  .mrc-table td:first-child {
    font-family: 'IBM Plex Mono', monospace;
    font-weight: 600;
    font-size: 1rem;
    color: var(--accent);
    width: 48px;
    text-align: center;
  }
  .mrc-table tr.highlight td { color: var(--text); background: #1a2a3d22; }

  .mrc-table tbody tr {
    cursor: pointer;
    transition: background 0.15s;
  }
  .mrc-table tbody tr:hover td { background: #2d333b; color: var(--text); }
  .mrc-table tbody tr.mrc-selected td {
    background: #1a2a3d;
    color: var(--text);
  }
  .mrc-table tbody tr.mrc-selected td:first-child { color: var(--accent); }

  .mrc-select-hint {
    font-size: 0.72rem;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.35rem;
  }

  .mrc-apply-btn {
    width: 100%;
    margin-top: 1rem;
    background: var(--accent);
    border: none;
    border-radius: 5px;
    color: #0d1117;
    cursor: pointer;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 0.88rem;
    font-weight: 600;
    padding: 0.6rem;
    transition: opacity 0.15s;
  }
  .mrc-apply-btn:hover { opacity: 0.85; }
  .mrc-apply-btn:disabled { opacity: 0.35; cursor: default; }

  @media (max-width: 580px) {
    header h1 { font-size: 1.3rem; }
    .outcomes-row { grid-template-columns: 1fr 1fr; }
    .blabel { width: 130px; }
    .score-number { font-size: 3rem; }
    .result-panel { gap: 1.25rem; }
    .bmi-inputs { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="container">

  <a href="../" class="back-link">← Strona główna</a>

  <header>
    <div class="tag">Kalkulator kliniczny</div>
    <h1>Bronchiectasis Severity Index (BSI)</h1>
    <p>Skala oceny ciężkości rozstrzeni oskrzeli · maksymalnie 24 punkty</p>
  </header>

  <!-- RESET -->
  <button class="reset-btn" onclick="resetAll()">
    <span>↺</span> Resetuj wszystkie pola
  </button>

  <!-- WIEK -->
  <div class="param-block">
    <div class="param-header">
      <div class="param-name-row">
        <span class="param-name">Wiek</span>
      </div>
      <span class="param-score" id="sc-age">0 pkt</span>
    </div>
    <div class="btn-group" data-param="age">
      <button class="opt-btn selected" data-val="0">&lt; 50 lat <span class="pts">+0</span></button>
      <button class="opt-btn" data-val="2">50–69 lat <span class="pts">+2</span></button>
      <button class="opt-btn" data-val="4">70–79 lat <span class="pts">+4</span></button>
      <button class="opt-btn" data-val="6">≥ 80 lat <span class="pts">+6</span></button>
    </div>
  </div>

  <!-- BMI -->
  <div class="param-block">
    <div class="param-header">
      <div class="param-name-row">
        <span class="param-name">BMI (kg·m⁻²)</span>
        <button class="icon-btn" onclick="openBMI()" title="Kalkulator BMI">⊞ BMI</button>
      </div>
      <span class="param-score" id="sc-bmi">0 pkt</span>
    </div>
    <div class="btn-group" data-param="bmi">
      <button class="opt-btn" data-val="2">&lt; 18,5 <span class="pts">+2</span></button>
      <button class="opt-btn selected" data-val="0">18,5–25 <span class="pts">+0</span></button>
      <button class="opt-btn" data-val="0">26–29 <span class="pts">+0</span></button>
      <button class="opt-btn" data-val="0">≥ 30 <span class="pts">+0</span></button>
    </div>
  </div>

  <!-- FEV1 -->
  <div class="param-block">
    <div class="param-header">
      <div class="param-name-row">
        <span class="param-name">FEV<sub>1</sub> (% wartości należnej)</span>
      </div>
      <span class="param-score" id="sc-fev1">0 pkt</span>
    </div>
    <div class="btn-group" data-param="fev1">
      <button class="opt-btn selected" data-val="0">&gt; 80% <span class="pts">+0</span></button>
      <button class="opt-btn" data-val="1">50–80% <span class="pts">+1</span></button>
      <button class="opt-btn" data-val="2">30–49% <span class="pts">+2</span></button>
      <button class="opt-btn" data-val="3">&lt; 30% <span class="pts">+3</span></button>
    </div>
  </div>

  <!-- HOSPITALIZACJA -->
  <div class="param-block">
    <div class="param-header">
      <div class="param-name-row">
        <span class="param-name">Poprzednia hospitalizacja z powodu zaostrzenia</span>
      </div>
      <span class="param-score" id="sc-hosp">0 pkt</span>
    </div>
    <div class="btn-group" data-param="hosp">
      <button class="opt-btn selected" data-val="0">Nie <span class="pts">+0</span></button>
      <button class="opt-btn" data-val="5">Tak <span class="pts">+5</span></button>
    </div>
  </div>

  <!-- ZAOSTRZENIA -->
  <div class="param-block">
    <div class="param-header">
      <div class="param-name-row">
        <span class="param-name">Liczba zaostrzeń w poprzednim roku</span>
      </div>
      <span class="param-score" id="sc-exac">0 pkt</span>
    </div>
    <div class="btn-group" data-param="exac">
      <button class="opt-btn selected" data-val="0">0 <span class="pts">+0</span></button>
      <button class="opt-btn" data-val="0">1–2 <span class="pts">+0</span></button>
      <button class="opt-btn" data-val="2">≥ 3 <span class="pts">+2</span></button>
    </div>
  </div>

  <!-- MRC -->
  <div class="param-block">
    <div class="param-header">
      <div class="param-name-row">
        <span class="param-name">Duszność wg skali MRC</span>
        <button class="icon-btn" onclick="openMRC()" title="Opis skali MRC">☰ Skala</button>
      </div>
      <span class="param-score" id="sc-mrc">0 pkt</span>
    </div>
    <div class="btn-group" data-param="mrc">
      <button class="opt-btn selected" data-val="0">1–3 <span class="pts">+0</span></button>
      <button class="opt-btn" data-val="2">4 <span class="pts">+2</span></button>
      <button class="opt-btn" data-val="3">5 <span class="pts">+3</span></button>
    </div>
  </div>

  <!-- PSEUDOMONAS -->
  <div class="param-block">
    <div class="param-header">
      <div class="param-name-row">
        <span class="param-name">Kolonizacja <em>Pseudomonas aeruginosa</em></span>
      </div>
      <span class="param-score" id="sc-pseudo">0 pkt</span>
    </div>
    <div class="btn-group" data-param="pseudo">
      <button class="opt-btn selected" data-val="0">Nie <span class="pts">+0</span></button>
      <button class="opt-btn" data-val="3">Tak <span class="pts">+3</span></button>
    </div>
  </div>

  <!-- INNE -->
  <div class="param-block">
    <div class="param-header">
      <div class="param-name-row">
        <span class="param-name">Kolonizacja innymi drobnoustrojami (poza <em>P. aeruginosa</em>)</span>
      </div>
      <span class="param-score" id="sc-other">0 pkt</span>
    </div>
    <div class="btn-group" data-param="other">
      <button class="opt-btn selected" data-val="0">Nie <span class="pts">+0</span></button>
      <button class="opt-btn" data-val="1">Tak <span class="pts">+1</span></button>
    </div>
  </div>

  <!-- RADIOLOGIA -->
  <div class="param-block">
    <div class="param-header">
      <div class="param-name-row">
        <span class="param-name">Rozległość radiologiczna: ≥ 3 płaty lub rozstrzenie torbielowate</span>
      </div>
      <span class="param-score" id="sc-radio">0 pkt</span>
    </div>
    <div class="btn-group" data-param="radio">
      <button class="opt-btn selected" data-val="0">Nie <span class="pts">+0</span></button>
      <button class="opt-btn" data-val="1">Tak <span class="pts">+1</span></button>
    </div>
  </div>

  <!-- WYNIK -->
  <div class="result-panel">
    <div class="score-circle">
      <div class="score-number c-low" id="score-num">0</div>
      <div class="score-max">/ 24 pkt</div>
    </div>

    <div class="result-right">
      <div class="severity-label c-low" id="sev-label">Łagodna</div>
      <div class="severity-range" id="sev-range">BSI 0–4</div>
      <div class="result-desc" id="sev-desc">Niskie ryzyko hospitalizacji i zgonu. Zalecana regularna kontrola, optymalizacja leczenia inhalacyjnego i fizjoterapia oddechowa.</div>

      <div class="outcomes-row">
        <div class="outcome-box">
          <div class="outcome-val c-low" id="out-mort">5,3%</div>
          <div class="outcome-lbl">Śmiertelność 4-letnia</div>
        </div>
        <div class="outcome-box">
          <div class="outcome-val c-low" id="out-hosp">0,5/rok</div>
          <div class="outcome-lbl">Hospitalizacje/rok</div>
        </div>
        <div class="outcome-box">
          <div class="outcome-val c-low" id="out-exac">1,5/rok</div>
          <div class="outcome-lbl">Zaostrzenia/rok</div>
        </div>
      </div>

      <div class="breakdown">
        <div class="breakdown-title">Składowe punktacji</div>
        <div id="breakdown-body"></div>
      </div>
    </div>
  </div>

  <div class="source">
    Chalmers JD, Haworth CS, Flume P, et al. European Respiratory Society clinical practice guideline for the management of adult bronchiectasis. <em>Eur Respir J</em> 2025; 66: 2501126. DOI: 10.1183/13993003.01126-2025
  </div>

</div>

<!-- ========== MODAL: KALKULATOR BMI ========== -->
<div class="modal-overlay" id="modal-bmi" onclick="closeBMI(event)">
  <div class="modal">
    <button class="modal-close" onclick="closeBMI()">✕</button>
    <h2>⊞ Kalkulator BMI</h2>
    <div class="bmi-inputs">
      <div class="bmi-field">
        <label>Masa ciała (kg)</label>
        <input type="number" id="bmi-weight" placeholder="np. 72" min="20" max="300" oninput="calcBMI()">
      </div>
      <div class="bmi-field">
        <label>Wzrost (cm)</label>
        <input type="number" id="bmi-height" placeholder="np. 175" min="100" max="250" oninput="calcBMI()">
      </div>
    </div>
    <div class="bmi-result">
      <div class="bmi-val" id="bmi-val">—</div>
      <div class="bmi-cat" id="bmi-cat">Wprowadź masę ciała i wzrost</div>
    </div>
    <button class="bmi-apply-btn" id="bmi-apply" onclick="applyBMI()" disabled>
      Zastosuj wynik w kalkulatorze BSI
    </button>
  </div>
</div>

<!-- ========== MODAL: SKALA MRC ========== -->
<div class="modal-overlay" id="modal-mrc" onclick="closeMRC(event)">
  <div class="modal">
    <button class="modal-close" onclick="closeMRC()">✕</button>
    <h2>☰ Skala duszności MRC</h2>
    <p class="mrc-select-hint">↑ Kliknij wiersz, aby wybrać stopień</p>
    <table class="mrc-table" id="mrc-table">
      <thead>
        <tr>
          <th>Stopień</th>
          <th>Opis</th>
        </tr>
      </thead>
      <tbody>
        <tr data-mrc="1" data-bsi-btn="0" onclick="selectMRC(this)">
          <td>1</td>
          <td>Duszność tylko przy bardzo dużym wysiłku fizycznym <span style="color:var(--text-muted);font-size:0.73rem;margin-left:0.3rem">0 pkt</span></td>
        </tr>
        <tr data-mrc="2" data-bsi-btn="0" onclick="selectMRC(this)">
          <td>2</td>
          <td>Duszność przy szybkim marszu po równym terenie lub przy chodzeniu pod górę <span style="color:var(--text-muted);font-size:0.73rem;margin-left:0.3rem">0 pkt</span></td>
        </tr>
        <tr data-mrc="3" data-bsi-btn="0" onclick="selectMRC(this)">
          <td>3</td>
          <td>Chodzi wolniej niż osoby w tym samym wieku lub musi się zatrzymywać podczas marszu po równym terenie <span style="color:var(--text-muted);font-size:0.73rem;margin-left:0.3rem">0 pkt</span></td>
        </tr>
        <tr data-mrc="4" data-bsi-btn="1" onclick="selectMRC(this)" class="highlight">
          <td>4</td>
          <td>Musi się zatrzymywać po przejściu około 100 metrów lub po kilku minutach marszu po równym terenie <span style="color:var(--accent);font-size:0.73rem;margin-left:0.3rem">+2 pkt</span></td>
        </tr>
        <tr data-mrc="5" data-bsi-btn="2" onclick="selectMRC(this)" class="highlight">
          <td>5</td>
          <td>Zbyt duszny, by wyjść z domu; duszność przy ubieraniu się lub rozbieraniu <span style="color:var(--accent);font-size:0.73rem;margin-left:0.3rem">+3 pkt</span></td>
        </tr>
      </tbody>
    </table>
    <button class="mrc-apply-btn" id="mrc-apply" onclick="applyMRC()" disabled>
      Zastosuj wybrany stopień w kalkulatorze BSI
    </button>
  </div>
</div>

<script>
/* ============================================================
   PARAMETRY BSI
============================================================ */
const PARAMS = [
  { id: 'age',    label: 'Wiek',                    max: 6 },
  { id: 'bmi',    label: 'BMI',                     max: 2 },
  { id: 'fev1',   label: 'FEV₁',                    max: 3 },
  { id: 'hosp',   label: 'Hospitalizacja',           max: 5 },
  { id: 'exac',   label: 'Zaostrzenia',              max: 2 },
  { id: 'mrc',    label: 'Duszność MRC',             max: 3 },
  { id: 'pseudo', label: 'P. aeruginosa',            max: 3 },
  { id: 'other',  label: 'Inne drobnoustroje',       max: 1 },
  { id: 'radio',  label: 'Rozległość radiologiczna', max: 1 },
];

const state = {};
PARAMS.forEach(p => state[p.id] = 0);

// Store default (first selected) button per param for reset
const DEFAULTS = {};

const OUTCOMES = {
  mild:     { label: 'Łagodna',     range: 'BSI 0–4',  cls: 'c-low',  mort: '5,3%',  hosp: '0,5/rok', exac: '1,5/rok', desc: 'Niskie ryzyko hospitalizacji i zgonu. Zalecana regularna kontrola, optymalizacja leczenia inhalacyjnego i fizjoterapia oddechowa.' },
  moderate: { label: 'Umiarkowana', range: 'BSI 5–8',  cls: 'c-mid',  mort: '10,4%', hosp: '1,4/rok', exac: '2,6/rok', desc: 'Umiarkowane ryzyko. Wskazana intensyfikacja nadzoru, rozważenie długotrwałej antybiotykoterapii i regularnych posiewów plwociny.' },
  severe:   { label: 'Ciężka',      range: 'BSI ≥ 9',  cls: 'c-high', mort: '29,2%', hosp: '2,9/rok', exac: '3,4/rok', desc: 'Wysokie ryzyko hospitalizacji i zgonu. Konieczna intensywna opieka specjalistyczna. Rozważenie antybiotykoterapii wziewnej i skierowania do ośrodka referencyjnego.' },
};

/* Attach button listeners */
document.querySelectorAll('.btn-group').forEach(group => {
  const param = group.dataset.param;
  const btns = group.querySelectorAll('.opt-btn');

  // Find default
  btns.forEach((btn, i) => {
    if (btn.classList.contains('selected')) DEFAULTS[param] = i;
  });

  btns.forEach(btn => {
    btn.addEventListener('click', () => {
      btns.forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      state[param] = parseInt(btn.dataset.val) || 0;
      render();
    });
  });
});

function render() {
  let total = 0;
  PARAMS.forEach(p => total += state[p.id]);

  document.getElementById('score-num').textContent = total;
  const cat = total <= 4 ? 'mild' : total <= 8 ? 'moderate' : 'severe';
  const o = OUTCOMES[cat];

  document.getElementById('score-num').className = 'score-number ' + o.cls;
  const sevEl = document.getElementById('sev-label');
  sevEl.textContent = o.label;
  sevEl.className = 'severity-label ' + o.cls;
  document.getElementById('sev-range').textContent = o.range;
  document.getElementById('sev-desc').textContent = o.desc;

  ['mort','hosp','exac'].forEach(k => {
    document.getElementById('out-' + k).className = 'outcome-val ' + o.cls;
  });
  document.getElementById('out-mort').textContent = o.mort;
  document.getElementById('out-hosp').textContent = o.hosp;
  document.getElementById('out-exac').textContent = o.exac;

  PARAMS.forEach(p => {
    const el = document.getElementById('sc-' + p.id);
    if (!el) return;
    const pts = state[p.id];
    el.textContent = pts + ' pkt';
    el.className = 'param-score' + (pts > 0 ? ' scored' : '');
  });

  const body = document.getElementById('breakdown-body');
  body.innerHTML = '';
  PARAMS.forEach(p => {
    const pts = state[p.id];
    const pct = p.max > 0 ? (pts / p.max * 100) : 0;
    const has = pts > 0;
    const row = document.createElement('div');
    row.className = 'breakdown-bar-row';
    row.innerHTML = `
      <span class="blabel${has ? ' has' : ''}">${p.label}</span>
      <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
      <span class="bscore${has ? ' has' : ''}">+${pts}</span>`;
    body.appendChild(row);
  });
}

/* ============================================================
   RESET
============================================================ */
function resetAll() {
  document.querySelectorAll('.btn-group').forEach(group => {
    const param = group.dataset.param;
    const btns = group.querySelectorAll('.opt-btn');
    btns.forEach(b => b.classList.remove('selected'));
    const defIdx = DEFAULTS[param] ?? 0;
    btns[defIdx].classList.add('selected');
    state[param] = parseInt(btns[defIdx].dataset.val) || 0;
  });
  render();
}

/* ============================================================
   MODAL BMI
============================================================ */
let bmiValue = null;

function openBMI() {
  document.getElementById('modal-bmi').classList.add('open');
  document.getElementById('bmi-weight').focus();
}

function closeBMI(e) {
  if (!e || e.target === document.getElementById('modal-bmi')) {
    document.getElementById('modal-bmi').classList.remove('open');
  }
}

function calcBMI() {
  const w = parseFloat(document.getElementById('bmi-weight').value);
  const h = parseFloat(document.getElementById('bmi-height').value) / 100;
  const applyBtn = document.getElementById('bmi-apply');

  if (!w || !h || h <= 0) {
    document.getElementById('bmi-val').textContent = '—';
    document.getElementById('bmi-cat').textContent = 'Wprowadź masę ciała i wzrost';
    applyBtn.disabled = true;
    bmiValue = null;
    return;
  }

  const bmi = w / (h * h);
  bmiValue = bmi;
  document.getElementById('bmi-val').textContent = bmi.toFixed(1);

  let cat;
  if (bmi < 18.5) cat = 'Niedowaga (BMI < 18,5)';
  else if (bmi < 26) cat = 'Waga prawidłowa (18,5–25,9)';
  else if (bmi < 30) cat = 'Nadwaga (26–29,9)';
  else cat = 'Otyłość (≥ 30)';

  document.getElementById('bmi-cat').textContent = cat;
  applyBtn.disabled = false;
}

function applyBMI() {
  if (bmiValue === null) return;

  // Find matching BMI button index: <18.5 → 0, 18.5-25 → 1, 26-29 → 2, ≥30 → 3
  let idx;
  if (bmiValue < 18.5) idx = 0;
  else if (bmiValue < 26) idx = 1;
  else if (bmiValue < 30) idx = 2;
  else idx = 3;

  const group = document.querySelector('[data-param="bmi"]');
  const btns = group.querySelectorAll('.opt-btn');
  btns.forEach(b => b.classList.remove('selected'));
  btns[idx].classList.add('selected');
  state['bmi'] = parseInt(btns[idx].dataset.val) || 0;
  render();
  closeBMI();
}

/* ============================================================
   MODAL MRC
============================================================ */
let selectedMRCRow = null;

function openMRC() {
  document.getElementById('modal-mrc').classList.add('open');
  // Pre-highlight currently selected MRC button index
  const group = document.querySelector('[data-param="mrc"]');
  const btns = group.querySelectorAll('.opt-btn');
  let currentBtnIdx = 0;
  btns.forEach((b, i) => { if (b.classList.contains('selected')) currentBtnIdx = i; });

  // Map btn index → mrc grade mapping: 0→"1-3", 1→"4", 2→"5"
  // We'll highlight the first row in the range for btn 0
  const rows = document.querySelectorAll('#mrc-table tbody tr');
  rows.forEach(r => r.classList.remove('mrc-selected'));
  selectedMRCRow = null;

  // Pre-select based on current BSI selection
  let targetMrc = null;
  if (currentBtnIdx === 1) targetMrc = '4';
  else if (currentBtnIdx === 2) targetMrc = '5';

  if (targetMrc) {
    rows.forEach(r => {
      if (r.dataset.mrc === targetMrc) {
        r.classList.add('mrc-selected');
        selectedMRCRow = r;
      }
    });
  }
  document.getElementById('mrc-apply').disabled = (selectedMRCRow === null);
}

function selectMRC(row) {
  document.querySelectorAll('#mrc-table tbody tr').forEach(r => r.classList.remove('mrc-selected'));
  row.classList.add('mrc-selected');
  selectedMRCRow = row;
  document.getElementById('mrc-apply').disabled = false;
}

function applyMRC() {
  if (!selectedMRCRow) return;
  const btnIdx = parseInt(selectedMRCRow.dataset.bsiBtn);
  const group = document.querySelector('[data-param="mrc"]');
  const btns = group.querySelectorAll('.opt-btn');
  btns.forEach(b => b.classList.remove('selected'));
  btns[btnIdx].classList.add('selected');
  state['mrc'] = parseInt(btns[btnIdx].dataset.val) || 0;
  render();
  closeMRC();
}

function closeMRC(e) {
  if (!e || e.target === document.getElementById('modal-mrc')) {
    document.getElementById('modal-mrc').classList.remove('open');
  }
}

// Close modals on Escape
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeBMI(); closeMRC(); }
});

render();
</script>
</body>
</html>
